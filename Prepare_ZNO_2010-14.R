#install packages
{
if (!("dplyr" %in% installed.packages())) {install.packages("dplyr")}
if (!("readxl" %in% installed.packages())) {install.packages("readxl")}
if (!("stringr" %in% installed.packages())) {install.packages("stringr")}
if (!("data.table" %in% installed.packages())) {install.packages("data.table")}
}

#load libraries
{
library(data.table)
library(dplyr)
library(stringr)
library(readxl)
}

#set environment parameters
{
#set workspace directory
setwd("C:/Users/certa/Desktop/R/ZNO/ZNO 2010-2019")

#setting proper locale
Sys.setlocale('LC_ALL','ukrainian')
}


prepare_dataset <- function(path,year){
  
  #setting subject names
  subj_names <- c("???????????????????? ???????? ???? ????????????????????","?????????????? ??????????????","????????????????????","????????????","??????????",
                  "????????????????","??????????????????","???????????????????? ????????","???????????????????? ????????",
                  "???????????????? ????????","?????????????????? ????????","?????????????????? ????????",
                  "?????????????????? ??????????????","?????????????? ????????????????????")
  
  #combine subject names into one string for matching
  subj_pat <- paste(subj_names,collapse = "|")
  
  #create list of filenames
  file_list <- list.files(path)
  
  #initialize empty dataframe
  data_set <- data.frame()
  
  #create dataset from files content
  for (i in 1:length(file_list)) {
    
    #read data from each file from directory w/o first row into temp dataframe
    temp_data <- read_excel(str_c(path,file_list[i],sep = "/"),skip = 1)
    
    #crop subject name and put value in respective column
    temp_data <- temp_data %>% 
      mutate(test=str_match(file_list[i],subj_pat)) %>% 
      select(1:2,test,everything())
    
    #compose filename w/o subject name
    f_n <- str_split(str_remove(file_list[i],subj_pat),
                     pattern=fixed(","),simplify = T)
    
    #fetch region name from filename amd put in column eoregname
    temp_data <- temp_data %>% mutate(eoregname=str_trim(f_n[,1])) %>%
      select(1:test,eoregname,everything())
    
    #remove file extention
    f_n2 <- str_remove(f_n[,2],".XLSX|.xlsx")
    
    #add column eoareaname and put value
    temp_data <- temp_data %>% mutate(eoareaname=str_trim(f_n2)) %>% 
      select(1:eoregname,eoareaname,everything())
    
    #bind in result data_set
    data_set <- rbindlist(list(data_set,temp_data),use.names = TRUE)
    
  }
  
  #change column names
  data_set <- data_set %>% 
    rename(eoname='??????????',
           eotypename='??????')
    
  data_set[,2:5] <- lapply(data_set[,2:5],as.factor)
  
  data_set[,6:16] <- lapply(data_set[,6:16],
                            function(data_set){as.numeric(gsub(",",".",data_set))})
  
  data_set <- data_set %>% 
    mutate(`range_100-123.5`=round((`?????? 100 ???? 123.5`/100)*`?????????? ????????????`),
           `range_124-135.5`=round((`?????? 124 ???? 135.5`/100)*`?????????? ????????????`),
           `range_136-150`=round((`?????? 136 ???? 150`/100)*`?????????? ????????????`),
           `range_150.5-161.5`=round((`?????? 150.5 ???? 161.5`/100)*`?????????? ????????????`),
           `range_162-172.5`=round((`?????? 162 ???? 172.5`/100)*`?????????? ????????????`),
           `range_173-183`=round((`?????? 173 ???? 183`/100)*`?????????? ????????????`),
           `range_183.5-190`=round((`?????? 183.5 ???? 190`/100)*`?????????? ????????????`),
           `range_190.5-195`=round((`?????? 190.5 ???? 195`/100)*`?????????? ????????????`),
           `range_195.5-199.5`=round((`?????? 195.5 ???? 199.5`/100)*`?????????? ????????????`),
           `range_200`=round((`200`/100)*`?????????? ????????????`))
  
  data_set <- data_set %>% mutate(year=year) %>% 
    select(year,eoname:eotypename,eoregname:eoareaname,
           test, everything()) %>% 
    select(-c('?????????? ????????????':'200'))
  
  #remove quotes from data set
  data_set$eoname <- str_remove_all(data_set$eoname,'["//]')
  
  return (data_set)
  
}

#path to source files
path_2014 <- "ZNO2014/all_files"

zno_2014 <- prepare_dataset(path_2014,2014)

write_csv(zno_2014,"ZNO_14_tests_school_data.csv",
          quote_escape = "none")

data_set <- data_set %>% 
  mutate(diff=`?????????? ????????????`-apply(.[,c(7:16)],1,sum))

  
summary(data_set)


reg_data <- data_set %>% filter(test=="????????????????????") %>%  
  group_by(eoregname) %>% tally(`?????????? ????????????`)
